{"version":3,"sources":["lib/test-backend.js"],"names":["TestBackend","nconf","logger","simulateDelays","hilbertCLIConnector","mkLivestatusConnector","state","Map","station_cfg","stationCFG","station","addStation","set","id","name","type","default_app","possible_apps","initStationState","HostState","DOWN","state_type","StateType","HARD","app_state","ServiceState","UNKNOWN","app_state_type","app_id","values","output","Promise","resolve","write","randomDelay","then","stationID","stationState","get","stationCfg","UP","OK","appID","reject","indexOf","min","max","delay","Math","floor","random","setTimeout"],"mappings":"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","file":"lib/test-backend.js","sourcesContent":["import Nagios from './nagios';\nimport TestHilbertCLIConnector from './test-hilbert-cli-connector';\nimport TestMKLivestatusConnector from './test-mk-livestatus-connector';\n\nexport default class TestBackend {\n\n  constructor(nconf, logger) {\n    this.simulateDelays = false;\n    this.nconf = nconf;\n    this.logger = logger;\n\n    this.hilbertCLIConnector = new TestHilbertCLIConnector(this, nconf, logger);\n    this.mkLivestatusConnector = new TestMKLivestatusConnector(this, nconf, logger);\n\n    this.state = new Map();\n    this.station_cfg = new Map();\n  }\n\n  /**\n   * Loads test data\n   *\n   * If any data was previously loaded it's overwritten.\n   *\n   * @param {Array} stationCFG An array of station configurations\n   */\n  load(stationCFG) {\n    this.state = new Map();\n    this.station_cfg = new Map();\n\n    for (const station of stationCFG) {\n      this.addStation(station);\n    }\n  }\n\n  /**\n   * Adds a station\n   *\n   * @param {Object} station Station definition\n   *   The definition should have the following properties:\n   *   - id {String} Unique identifier\n   *   - name {String} Human readable name\n   *   - type {String} Type of the station\n   *   - default_app {String} Default application ID\n   *   - possible_apps {Array} List of compatible applications (app IDs)\n   */\n  addStation(station) {\n    this.station_cfg.set(station.id, {\n      id: station.id,\n      name: station.name,\n      type: station.type,\n      default_app: station.default_app,\n      possible_apps: station.possible_apps,\n    });\n\n    this.initStationState(station.id);\n  }\n\n  /**\n   * Initializes the state of a station to the default (station down, app down)\n   *\n   * @param {String} id Station ID\n   */\n  initStationState(id) {\n    this.state.set(id, {\n      id,\n      state: Nagios.HostState.DOWN,\n      state_type: Nagios.StateType.HARD,\n      app_state: Nagios.ServiceState.UNKNOWN,\n      app_state_type: Nagios.StateType.HARD,\n      app_id: '',\n    });\n  }\n\n  /**\n   * Returns a HilbertCLIConnector stub for testing\n   * @returns {TestHilbertCLIConnector}\n   */\n  getHilbertCLIConnector() {\n    return this.hilbertCLIConnector;\n  }\n\n  /**\n   * Returns a MKLivestatusConnector stub for testing\n   * @returns {TestMKLivestatusConnector}\n   */\n  getMKLivestatusConnector() {\n    return this.mkLivestatusConnector;\n  }\n\n  getStationState() {\n    return this.state.values();\n  }\n\n  /**\n   * Reads the station config\n   * @returns {Promise}\n   * @resolve {Array} - List of stations\n   * @reject {Error}\n   */\n  getStationConfig(output) {\n    return new Promise((resolve) => {\n      output.write('Simulating reading station configuration. Waiting a random delay...');\n      this.randomDelay(1000, 3000).then(() => {\n        output.write('Wait finished.');\n        resolve(this.station_cfg.values());\n      });\n    });\n  }\n\n  /**\n   * Starts a station\n   *\n   * @param stationID\n   * @param {stream} output - Command output should be written here\n   * @returns {Promise}\n   */\n  startStation(stationID, output) {\n    return new Promise((resolve) => {\n      output.write(`Simulating starting station ${stationID}. Waiting a random delay...`);\n      this.randomDelay(3000, 8000).then(() => {\n        output.write('Wait finished.');\n        const stationState = this.state.get(stationID);\n        const stationCfg = this.station_cfg.get(stationID);\n        if (stationState && (stationState.state === Nagios.HostState.DOWN)) {\n          stationState.state = Nagios.HostState.UP;\n          stationState.app_state = Nagios.ServiceState.OK;\n          stationState.app_state_type = Nagios.StateType.HARD;\n          stationState.app_id = stationCfg.default_app;\n          output.write(`Station state set to UP with app ${stationState.app_id}.`);\n        }\n      }).then(resolve);\n    });\n  }\n\n  /**\n   * Stops a station\n   *\n   * @param stationID\n   * @param {stream} output - Command output should be written here\n   * @returns {Promise}\n   */\n  stopStation(stationID, output) {\n    return new Promise((resolve) => {\n      output.write(`Simulating stopping station ${stationID}. Waiting a random delay...`);\n      this.randomDelay(2000, 6000).then(() => {\n        output.write('Wait finished.');\n        const stationState = this.state.get(stationID);\n        if (stationState && (stationState.state === Nagios.HostState.UP)) {\n          stationState.state = Nagios.HostState.DOWN;\n          stationState.app_state = Nagios.ServiceState.UNKNOWN;\n          stationState.app_state_type = Nagios.StateType.HARD;\n          stationState.app_id = '';\n          output.write('Station state set to DOWN.');\n        }\n      }).then(resolve);\n    });\n  }\n\n  /**\n   * Change the foreground application running in a station\n   *\n   * @param {string} stationID - ID of the station\n   * @param {string} appID - ID of the app to set\n   * @param {stream} output - Command output should be written here\n   * @returns {Promise}\n   */\n  changeApp(stationID, appID, output) {\n    return new Promise((resolve, reject) => {\n      output.write(\n        `Simulating changing app for station ${stationID} to ${appID}. Waiting a random delay...`);\n      this.randomDelay(1000, 5000).then(() => {\n        output.write('Wait finished.');\n        const stationState = this.state.get(stationID);\n        const stationCfg = this.station_cfg.get(stationID);\n\n        if (stationCfg.possible_apps.indexOf(appID) >= 0) {\n          stationState.app_id = appID;\n          output.write('App changed.');\n        }\n      }).then(() => {\n        if (appID === 'Sky explorer / Aladin lite') {\n          output.write('Simulating failure when changing app to Sky explorer');\n          reject();\n        } else {\n          resolve();\n        }\n      });\n    });\n  }\n\n  /**\n   * Wait a random amount of time\n   * @private\n   * @param min\n   * @param max\n   * @returns {Promise}\n   */\n  randomDelay(min, max) {\n    if (this.simulateDelays) {\n      return new Promise((resolve) => {\n        const delay = Math.floor(Math.random() * (max - min)) + min;\n        setTimeout(() => {\n          resolve();\n        }, delay);\n      });\n    }\n\n    return Promise.resolve();\n  }\n}\n"],"sourceRoot":"/source/"}